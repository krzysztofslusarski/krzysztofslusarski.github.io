---
layout: new
title:  "[Java][JVM] JVM internals basics - Stop-the-world phase (safepoints) - how it works?"
date:   2020-11-13 12:51:30 +0100
---

# [Java][JVM] JVM internals basics - Stop-the-world phase (safepoints) - how it works?
## Why does the JVM need STW phase?

The common knowledge in the Java developers world is that _garbage collectors_ need STW phase to clean dead objects.
First of all, **not only GC needs it**. There are other internal mechanisms that need to do some work, that require application threads to be hanged . 
For example JIT compiler needs STW phase to _deoptimize_ some compilations and to revoke _biased locks_. 

## How it works step by step

On your JVM there are running some application threads:

![alt text](/assets/stw/1.png "chart 1")
     
While running those threads from time to time JVM needs to do some work in the STW phase. So it start it with 
_global safepoint request_, which is an information for every thread to go to sleep:
  
![alt text](/assets/stw/2.png "chart 2")

Every thread has to find out about this information. Checking if it needs to fall asleep is simply a line on assembly code
generated by the JIT compiler and a simple step in the interpreter. Of course every thread can now execute a different method/JIT compilation, 
so time in which threads are going to be aware of STW phase is different for every thread.   
Every thread has to wait for the slowest one. Time between starting STW phase, and the slowest thread finding that information is called
_time to safepoint_:

![alt text](/assets/stw/3.png "chart 3")

Only after every thread is asleep, JVM threads can do the work that needed STW phase. A time when application threads were sleeping 
is called _safepoint operation time_: 

![alt text](/assets/stw/4.png "chart 4")

When JVM finishes its work application threads are waken up:

![alt text](/assets/stw/5.png "chart 5")

## What is important from all of this?

* **Not only GC causes STW phases** 
* If your application has a **long _time to safepoint_** then without that knowledge you probably won't find it
* **STW phase stops entire JVM**, so if you have multiple applications deployed on one JVM, one application has impact to all the rest
* **_Time to safepoint_** is the time of the slowest thread to reach the _safepoint_, **single compilation** can make a whole application slow, 
if it is running frequently

## Logging

_Safepoints_ has dedicated logs in a _unified logger_. You can enable it with ```Xlog:safepoint```. A following example comes
from **Java 11**:

```
[safepoint        ] Application time: 0.1950250 seconds
[safepoint        ] Entering safepoint region: RevokeBias
[safepoint        ] Leaving safepoint region
[safepoint        ] Total time for which application threads were stopped: 0.0003424 seconds, Stopping threads took: 0.0000491 seconds
```

A little bit of explanation what that means:
* First line "Application time: **0.1950250**": this is a time from last STW phase
* Second line "Entering safepoint region: **RevokeBias**": this is a name of _safepoint operation_ that needed STW phase
* Last line "Total time for which application threads were stopped: **0.0003424**": this is a sum of _time to safepoint_ and _safepoint operation time_
* Last line "Stopping threads took: **0.0000491**": this is a  _time to safepoint_

From that log we can generate cool charts. The first one is a pie chart that shows where our application is spending its time:

![alt text](/assets/stw/6.jpg "chart 6")

Second one shows distribution of count of each _safepoint operation_:

![alt text](/assets/stw/7.jpg "chart 7")

Next one shows distribution of time wasted by  _safepoint operation_:

![alt text](/assets/stw/8.jpg "chart 8")

Next one is probably **the most important** one, it shows in two second window which fraction of that time we spent running our application. If I have an
issue in any JVM application this is the first chart I look on.  

![alt text](/assets/stw/9.jpg "chart 9")

The last one shows distribution of time wasted in STW phases over time:

![alt text](/assets/stw/10.jpg "chart 10")

## Final words

The _Safepints_ logs are the only place where you can find complex information about all STW phases with _time to safepoint_. You should have them enabled
on every JVM. 